<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì •ì‹ ê³¼ ì§„ë£Œ ë³´ì¡° ì‹œìŠ¤í…œ - ì‹ ê²½í™”í•™ & ìˆ˜ìš©ì²´ ì‹œë®¬ë ˆì´í„°</title>
<style>
  /* --- ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ --- */
  body { background:#0a0a0a; color:#eee; font-family:'Segoe UI',sans-serif; margin:0; padding:20px; }
  .container { max-width:1600px; margin:0 auto; }
  h2 { text-align:center; color:#4fc3f7; margin-bottom:5px; }
  .subtitle { text-align:center; color:#888; font-size:13px; margin-bottom:20px; }
  .main-grid { display:grid; grid-template-columns:320px 1fr 300px; gap:15px; } /* ì™¼ìª½ íŒ¨ë„ ì•½ê°„ ë„“í˜ */
  canvas { background:#000; display:block; border:2px solid #333; border-radius:8px; width: 100%; }
  
  /* --- ì»¨íŠ¸ë¡¤ íŒ¨ë„ ìŠ¤íƒ€ì¼ --- */
  #controls { background:#1a1a1a; padding:15px; border-radius:8px; display:flex; flex-direction:column; gap:10px; max-height: 800px; overflow-y: auto; }
  
  .mode-switch { display:flex; background:#111; border-radius:6px; padding:4px; margin-bottom:15px; border:1px solid #333; flex-shrink: 0; }
  .mode-btn { flex:1; padding:8px; border:none; background:transparent; color:#666; cursor:pointer; font-weight:bold; border-radius:4px; transition:all 0.3s; font-size:13px; }
  .mode-btn.active { background:#4fc3f7; color:#000; box-shadow:0 2px 5px rgba(0,0,0,0.3); }
  
  .control-section { border-top: 1px solid #333; padding-top: 10px; margin-top: 5px; }
  .control-section-title { font-size: 11px; color: #4fc3f7; font-weight: bold; margin-bottom: 8px; display: block; }
  .control-group { margin-bottom:12px; }
  
  /* ì˜ì‚¬ìš© ì»¨íŠ¸ë¡¤ ìˆ¨ê¹€ ì²˜ë¦¬ */
  .doctor-only { display: none; }
  .doctor-only.visible { display: block; animation: fadeIn 0.3s; }
  
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  label { display:block; color:#aaa; font-size:12px; margin-bottom:3px; }
  input[type="number"], select, input[type="range"] { width:100%; padding:6px; background:#2a2a2a; border:1px solid #444; color:#fff; border-radius:4px; font-size:12px; box-sizing: border-box; }
  
  /* Range Slider ìŠ¤íƒ€ì¼ */
  input[type="range"] { -webkit-appearance: none; height: 4px; background: #444; outline: none; padding: 0; margin: 10px 0; }
  input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: #4fc3f7; border-radius: 50%; cursor: pointer; }
  
  .action-buttons { margin-top: auto; border-top: 1px solid #333; padding-top: 15px; flex-shrink: 0; }
  button { width:100%; padding:10px; margin:3px 0; background:#333; color:#fff; border:1px solid #444; border-radius:4px; cursor:pointer; font-weight:bold; font-size:12px; transition:0.2s; }
  button:hover { background:#444; }
  button#applyBtn { background:#4fc3f7; color:#000; border:none; margin-bottom:10px; }
  button#applyBtn:hover { background:#81d4fa; }
  
  /* --- ìš°ì¸¡ íŒ¨ë„ --- */
  #rightPanel { background:#1a1a1a; padding:15px; border-radius:8px; max-height:800px; overflow-y:auto; }
  .info-section { background:#2a2a2a; padding:12px; margin:8px 0; border-radius:6px; border-left:3px solid #4fc3f7; font-size:11px; line-height:1.5; }
  .info-title { color:#4fc3f7; font-weight:bold; margin-bottom:5px; font-size:12px; }
  .equation { background:#1a1a1a; padding:8px; margin:5px 0; border-radius:4px; font-family:monospace; font-size:11px; color:#ffaa00; }
  .value-display { color:#ff4444; font-weight:bold; }
  
  /* --- ë²”ë¡€ --- */
  #legend { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; font-size:11px; padding:10px; background:#1a1a1a; border-radius:6px; margin-top:10px; }
  .legend-item { display:flex; align-items:center; gap:5px; }
  .legend-color { width:15px; height:15px; border-radius:2px; }
  .neurotransmitter-bar { height:8px; background:#333; border-radius:4px; margin:5px 0; overflow:hidden; }
  .nt-fill { height:100%; transition:width 0.3s; }
  
  /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
  ::-webkit-scrollbar { width:8px; }
  ::-webkit-scrollbar-track { background:#1a1a1a; }
  ::-webkit-scrollbar-thumb { background:#4fc3f7; border-radius:4px; }
</style>
</head>
<body>
<div class="container">
  <h2>ğŸ§  ì •ì‹ ê³¼ ì§„ë£Œ ë³´ì¡° ì‹œìŠ¤í…œ - ì‹ ê²½í™”í•™ & ìˆ˜ìš©ì²´ ì‹œë®¬ë ˆì´í„°</h2>
  <div class="subtitle">ì•½ë¬¼ ê¸°ì „ ì‹œê°í™” ë° ìˆ˜ìš©ì²´ ë°˜ì‘ì„± ë¶„ì„ ë„êµ¬</div>
  
  <div class="main-grid">
    <div id="controls">
      <div class="mode-switch">
        <button class="mode-btn active" onclick="setMode('patient')">ğŸ‘¤ í™˜ììš© (ìƒë‹´)</button>
        <button class="mode-btn" onclick="setMode('doctor')">ğŸ‘¨â€âš•ï¸ ì˜ì‚¬ìš© (ì •ë°€ì„¤ì •)</button>
      </div>

      <div class="control-section">
        <span class="control-section-title">ğŸ’Š ì²˜ë°© ë° ìƒíƒœ ì„¤ì •</span>
        <div class="control-group">
          <label>ì•½ë¬¼/ë¬¼ì§ˆ ì„ íƒ</label>
          <select id="drugSelect">
            <option value="none">ì •ìƒ ìƒíƒœ (Baseline)</option>
            <option value="caffeine">ì¹´í˜ì¸ (Caffeine)</option>
            <option value="nicotine">ë‹ˆì½”í‹´ (Nicotine)</option>
            <option value="alcohol">ì•Œì½”ì˜¬ (Alcohol)</option>
            <option value="thc">ëŒ€ë§ˆ (THC)</option>
            <option value="mdma">MDMA</option>
            <option value="cocaine">ì½”ì¹´ì¸ (Cocaine)</option>
            <option value="amphetamine">ì•”í˜íƒ€ë¯¼ (Amphetamine)</option>
            <option value="lsd">LSD</option>
            <option value="psilocybin">ì‹¤ë¡œì‹œë¹ˆ (Psilocybin)</option>
            <option value="ketamine">ì¼€íƒ€ë¯¼ (Ketamine)</option>
          </select>
        </div>
        
        <div class="control-group">
          <label>íˆ¬ì—¬ëŸ‰ / ë†ë„ (mg)</label>
          <input id="dosage" type="number" value="100" min="0" step="10">
        </div>
        
        <div class="control-group">
          <label>ë³µìš© í›„ ê²½ê³¼ ì‹œê°„ (ë¶„)</label>
          <input id="timeElapsed" type="number" value="30" min="0" step="5">
        </div>
      </div>

      <div id="advancedControls" class="doctor-only">
        
        <div class="control-section">
          <span class="control-section-title">ğŸ”Œ ì‹ ê²½ìˆ˜ìš©ì²´ (Receptors) ë¯¼ê°ë„/ë°€ë„</span>
          <div class="subtitle" style="text-align:left; margin-bottom:5px;">(1.0=ì •ìƒ, <1.0=ë‚´ì„±/Downregulation, >1.0=ê³¼ë¯¼)</div>
          
          <div class="control-group">
            <label>D2 ë„íŒŒë¯¼ ìˆ˜ìš©ì²´: <span id="val_d2" style="color:#4fc3f7">1.0</span></label>
            <input id="rec_dopamine" type="range" min="0.1" max="2.0" step="0.1" value="1.0" oninput="document.getElementById('val_d2').innerText=this.value">
          </div>

          <div class="control-group">
            <label>5-HT ì„¸ë¡œí† ë‹Œ ìˆ˜ìš©ì²´: <span id="val_5ht" style="color:#4fc3f7">1.0</span></label>
            <input id="rec_serotonin" type="range" min="0.1" max="2.0" step="0.1" value="1.0" oninput="document.getElementById('val_5ht').innerText=this.value">
          </div>

          <div class="control-group">
            <label>GABA-A ìˆ˜ìš©ì²´: <span id="val_gaba" style="color:#4fc3f7">1.0</span></label>
            <input id="rec_gaba" type="range" min="0.1" max="2.0" step="0.1" value="1.0" oninput="document.getElementById('val_gaba').innerText=this.value">
          </div>

          <div class="control-group">
            <label>NMDA (ê¸€ë£¨íƒ€ë©”ì´íŠ¸) ìˆ˜ìš©ì²´: <span id="val_nmda" style="color:#4fc3f7">1.0</span></label>
            <input id="rec_glutamate" type="range" min="0.1" max="2.0" step="0.1" value="1.0" oninput="document.getElementById('val_nmda').innerText=this.value">
          </div>
        </div>

        <div class="control-section">
          <span class="control-section-title">âš™ï¸ ìƒë¬¼ë¬¼ë¦¬í•™ íŒŒë¼ë¯¸í„° (ê³ ê¸‰)</span>
          
          <div class="control-group">
            <label>ğŸ§¬ DNA ë‚˜ì„  ë°€ë„</label>
            <input id="helixDensity" type="number" value="0.7" min="0.1" max="1" step="0.1">
          </div>
          
          <div class="control-group">
            <label>ğŸŒŠ ìœ ì²´ ì ì„± (Î¼)</label>
            <input id="viscosity" type="number" value="0.05" min="0.01" max="0.2" step="0.01">
          </div>
          
          <div class="control-group">
            <label>âš¡ í™•ì‚° ê³„ìˆ˜ (D)</label>
            <input id="diffusion" type="number" value="1.5" min="0.5" max="5" step="0.5">
          </div>
          
          <div class="control-group">
            <label>ğŸ§ª pH ë ˆë²¨</label>
            <input id="pH" type="number" value="7.4" min="6.8" max="7.8" step="0.1">
          </div>
        </div>
      </div>
      
      <div class="action-buttons">
        <button id="applyBtn">ğŸš€ ì‹œë®¬ë ˆì´ì…˜ ì ìš©</button>
        <button id="pauseBtn">â¸ï¸ ì¼ì‹œì •ì§€ / ì¬ìƒ</button>
        <button id="resetBtn">ğŸ”„ ì´ˆê¸°í™”</button>
        <button id="saveBtn">ğŸ’¾ ìƒë‹´ ìë£Œ ì €ì¥</button>
      </div>
    </div>
    
    <div>
      <canvas id="canvas" width="1200" height="800"></canvas>
      <div id="legend">
        <div class="legend-item"><div class="legend-color" style="background:#ff4444;"></div>í™œì„± ë‡Œì˜ì—­</div>
        <div class="legend-item"><div class="legend-color" style="background:#444;"></div>ë¹„í™œì„±</div>
        <div class="legend-item"><div class="legend-color" style="background:#ffaa00;"></div>ì‹ ê²½ì „ë‹¬ë¬¼ì§ˆ</div>
        <div class="legend-item"><div class="legend-color" style="background:#4fc3f7;"></div>ì‹œëƒ…ìŠ¤/ìˆ˜ìš©ì²´</div>
        <div class="legend-item"><div class="legend-color" style="background:#0f0;"></div>ì „ì êµ¬ë¦„</div>
        <div class="legend-item"><div class="legend-color" style="background:red;"></div>DNA A</div>
        <div class="legend-item"><div class="legend-color" style="background:green;"></div>DNA T</div>
        <div class="legend-item"><div class="legend-color" style="background:blue;"></div>DNA C</div>
        <div class="legend-item"><div class="legend-color" style="background:yellow;"></div>DNA G</div>
      </div>
    </div>
    
    <div id="rightPanel"></div>
  </div>
</div>

<script>
// --- UI ì œì–´ ---
function setMode(mode) {
  const advancedControls = document.getElementById('advancedControls');
  const btns = document.querySelectorAll('.mode-btn');
  
  btns.forEach(btn => btn.classList.remove('active'));
  
  if (mode === 'doctor') {
    advancedControls.classList.add('visible');
    btns[1].classList.add('active');
  } else {
    advancedControls.classList.remove('visible');
    btns[0].classList.add('active');
  }
}

// ê¸°ì¡´ ë¡œì§ + ìˆ˜ìš©ì²´ ë¡œì§ ì¶”ê°€
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let isPaused = false;

// ë¬¼ë¦¬ ìƒìˆ˜
const BOLTZMANN = 1.380649e-23;
const PLANCK = 6.62607015e-34;
const AVOGADRO = 6.02214076e23;

// ë‡Œ ì˜ì—­ ì •ì˜
const brainRegions = {
  prefrontalCortex: { x: 600, y: 200, name: 'ì „ì „ë‘í”¼ì§ˆ', size: 40, dna: 'ATCGATCGATCG' },
  motorCortex: { x: 500, y: 180, name: 'ìš´ë™í”¼ì§ˆ', size: 35, dna: 'GCTAGCTAGCTA' },
  premotor: { x: 550, y: 170, name: 'ì „ìš´ë™í”¼ì§ˆ', size: 30, dna: 'CGCGATATCGCG' },
  parietalCortex: { x: 400, y: 200, name: 'ë‘ì •ì—½', size: 35, dna: 'TATACGCGTATA' },
  somatosensory: { x: 450, y: 220, name: 'ì²´ê°ê°', size: 30, dna: 'GCGCATATATAT' },
  temporalCortex: { x: 650, y: 350, name: 'ì¸¡ë‘ì—½', size: 35, dna: 'ATATATCGCGCG' },
  auditoryCortex: { x: 550, y: 330, name: 'ì²­ê°í”¼ì§ˆ', size: 30, dna: 'CGCGCGATATAT' },
  hippocampus: { x: 600, y: 400, name: 'í•´ë§ˆ', size: 28, dna: 'ATCGATCGATCG' },
  amygdala: { x: 650, y: 420, name: 'í¸ë„ì²´', size: 25, dna: 'GCTAGCTAGCTA' },
  occipitalCortex: { x: 300, y: 250, name: 'í›„ë‘ì—½', size: 35, dna: 'TATATACGCGCG' },
  visualCortex: { x: 350, y: 280, name: 'ì‹œê°í”¼ì§ˆ', size: 32, dna: 'CGCGATATATCG' },
  cingulate: { x: 550, y: 280, name: 'ëŒ€ìƒíšŒ', size: 30, dna: 'ATCGCGCGATCG' },
  insula: { x: 700, y: 300, name: 'ì„¬ì—½', size: 28, dna: 'GCGCATATGCGC' },
  striatum: { x: 600, y: 320, name: 'ì„ ì¡°ì²´', size: 30, dna: 'ATATCGCGATAT' },
  nucleusAccumbens: { x: 620, y: 340, name: 'ì¸¡ì¢Œí•µ', size: 25, dna: 'CGCGATCGCGAT' },
  substantiaNigra: { x: 580, y: 450, name: 'í‘ì§ˆ', size: 26, dna: 'ATCGATATATCG' },
  hypothalamus: { x: 600, y: 480, name: 'ì‹œìƒí•˜ë¶€', size: 24, dna: 'GCGCGCATATAT' },
  thalamus: { x: 550, y: 360, name: 'ì‹œìƒ', size: 28, dna: 'TATACGCGATAT' },
  brainstem: { x: 600, y: 550, name: 'ë‡Œê°„', size: 30, dna: 'ATCGCGCGCGAT' },
  cerebellum: { x: 450, y: 600, name: 'ì†Œë‡Œ', size: 40, dna: 'GCGCATATCGCG' },
  vta: { x: 560, y: 500, name: 'VTA', size: 22, dna: 'ATATATCGCGCG' },
  raphe: { x: 620, y: 520, name: 'ë´‰ì„ í•µ', size: 22, dna: 'CGCGCGATATAT' },
  locusCoeruleus: { x: 540, y: 540, name: 'ì²­ë°˜', size: 20, dna: 'ATATCGCGATCG' }
};

// í–¥ì •ì‹ ì„± ë¬¼ì§ˆ ë°ì´í„°
const drugData = {
  none: {
    name: 'ì •ìƒ ìƒíƒœ',
    activeRegions: ['prefrontalCortex', 'motorCortex', 'visualCortex', 'auditoryCortex', 'thalamus'],
    effectStrength: 0.3,
    dopamine: 0.5, serotonin: 0.5, gaba: 0.5, glutamate: 0.5, acetylcholine: 0.5,
    pH_shift: 0, osmolarity: 1.0, temperature: 310.15
  },
  caffeine: {
    name: 'ì¹´í˜ì¸',
    activeRegions: ['prefrontalCortex', 'motorCortex', 'premotor', 'parietalCortex', 'cingulate', 'thalamus', 'brainstem', 'locusCoeruleus'],
    effectStrength: 0.5,
    dopamine: 0.7, serotonin: 0.5, gaba: 0.4, glutamate: 0.6, acetylcholine: 0.6,
    pH_shift: 0.1, osmolarity: 1.05, temperature: 310.5
  },
  nicotine: {
    name: 'ë‹ˆì½”í‹´',
    activeRegions: ['prefrontalCortex', 'striatum', 'nucleusAccumbens', 'vta', 'hippocampus', 'amygdala', 'insula', 'thalamus'],
    effectStrength: 0.6,
    dopamine: 0.85, serotonin: 0.6, gaba: 0.5, glutamate: 0.7, acetylcholine: 0.9,
    pH_shift: -0.05, osmolarity: 1.02, temperature: 310.3
  },
  alcohol: {
    name: 'ì•Œì½”ì˜¬',
    activeRegions: ['prefrontalCortex', 'hippocampus', 'amygdala', 'cerebellum', 'brainstem', 'striatum'],
    inactiveRegions: ['motorCortex', 'premotor', 'somatosensory', 'visualCortex'],
    effectStrength: 0.7,
    dopamine: 0.6, serotonin: 0.55, gaba: 0.9, glutamate: 0.3, acetylcholine: 0.4,
    pH_shift: -0.15, osmolarity: 0.95, temperature: 309.8
  },
  thc: {
    name: 'THC',
    activeRegions: ['prefrontalCortex', 'hippocampus', 'amygdala', 'striatum', 'nucleusAccumbens', 'cerebellum', 'hypothalamus', 'vta'],
    effectStrength: 0.75,
    dopamine: 0.75, serotonin: 0.6, gaba: 0.7, glutamate: 0.65, acetylcholine: 0.55,
    pH_shift: 0.05, osmolarity: 1.08, temperature: 310.4
  },
  mdma: {
    name: 'MDMA',
    activeRegions: ['prefrontalCortex', 'amygdala', 'hippocampus', 'striatum', 'nucleusAccumbens', 'vta', 'raphe', 'insula', 'cingulate'],
    effectStrength: 0.9,
    dopamine: 0.8, serotonin: 0.95, gaba: 0.6, glutamate: 0.7, acetylcholine: 0.65,
    pH_shift: 0.2, osmolarity: 1.15, temperature: 311.5
  },
  cocaine: {
    name: 'ì½”ì¹´ì¸',
    activeRegions: ['prefrontalCortex', 'striatum', 'nucleusAccumbens', 'vta', 'motorCortex', 'amygdala', 'cingulate', 'insula', 'locusCoeruleus'],
    effectStrength: 0.95,
    dopamine: 0.98, serotonin: 0.7, gaba: 0.5, glutamate: 0.8, acetylcholine: 0.65,
    pH_shift: 0.15, osmolarity: 1.2, temperature: 311.2
  },
  amphetamine: {
    name: 'ì•”í˜íƒ€ë¯¼',
    activeRegions: ['prefrontalCortex', 'striatum', 'nucleusAccumbens', 'vta', 'motorCortex', 'premotor', 'parietalCortex', 'cingulate', 'locusCoeruleus'],
    effectStrength: 0.85,
    dopamine: 0.95, serotonin: 0.65, gaba: 0.45, glutamate: 0.75, acetylcholine: 0.7,
    pH_shift: 0.18, osmolarity: 1.18, temperature: 311.0
  },
  lsd: {
    name: 'LSD',
    activeRegions: ['prefrontalCortex', 'visualCortex', 'occipitalCortex', 'temporalCortex', 'parietalCortex', 'cingulate', 'insula', 'thalamus', 'raphe', 'hippocampus'],
    effectStrength: 0.95,
    dopamine: 0.7, serotonin: 0.98, gaba: 0.6, glutamate: 0.85, acetylcholine: 0.75,
    pH_shift: 0.12, osmolarity: 1.12, temperature: 310.8
  },
  psilocybin: {
    name: 'ì‹¤ë¡œì‹œë¹ˆ',
    activeRegions: ['prefrontalCortex', 'visualCortex', 'occipitalCortex', 'cingulate', 'hippocampus', 'amygdala', 'thalamus', 'raphe', 'insula'],
    effectStrength: 0.9,
    dopamine: 0.65, serotonin: 0.95, gaba: 0.55, glutamate: 0.8, acetylcholine: 0.7,
    pH_shift: 0.1, osmolarity: 1.1, temperature: 310.6
  },
  ketamine: {
    name: 'ì¼€íƒ€ë¯¼',
    activeRegions: ['prefrontalCortex', 'hippocampus', 'thalamus', 'cingulate'],
    inactiveRegions: ['motorCortex', 'cerebellum', 'somatosensory', 'visualCortex', 'auditoryCortex'],
    effectStrength: 0.85,
    dopamine: 0.7, serotonin: 0.6, gaba: 0.65, glutamate: 0.25, acetylcholine: 0.5,
    pH_shift: -0.1, osmolarity: 0.92, temperature: 309.9
  }
};

let currentDrug = 'none';
let animationFrame;
let time = 0;
let particles = [];
let electrons = [];
let fluidField = [];

// ìˆ˜ìš©ì²´ ì„¤ì •ê°’ ê°€ì ¸ì˜¤ê¸°
function getReceptorSettings() {
  return {
    dopamine: parseFloat(document.getElementById('rec_dopamine').value),
    serotonin: parseFloat(document.getElementById('rec_serotonin').value),
    gaba: parseFloat(document.getElementById('rec_gaba').value),
    glutamate: parseFloat(document.getElementById('rec_glutamate').value)
  };
}

// DNA ì´ì¤‘ë‚˜ì„  ìƒì„±
function generateDNAHelix(sequence, x0, y0, radius) {
  const helix = [];
  const baseColors = { A: '#ff0000', T: '#00ff00', C: '#0000ff', G: '#ffff00' };
  const pairs = { A: 'T', T: 'A', C: 'G', G: 'C' };
  
  for (let i = 0; i < sequence.length; i++) {
    const t = i * 0.5;
    const angle = t;
    const x1 = x0 + radius * Math.cos(angle);
    const y1 = y0 + radius * Math.sin(angle) + i * 2;
    const x2 = x0 - radius * Math.cos(angle);
    const y2 = y0 - radius * Math.sin(angle) + i * 2;
    
    helix.push({
      x1, y1, x2, y2,
      base1: sequence[i],
      base2: pairs[sequence[i]],
      color1: baseColors[sequence[i]],
      color2: baseColors[pairs[sequence[i]]]
    });
  }
  return helix;
}

// Navier-Stokes 2D ìœ ì²´ í•„ë“œ
function initFluidField() {
  fluidField = [];
  for (let i = 0; i < 50; i++) {
    for (let j = 0; j < 50; j++) {
      fluidField.push({
        x: i * 24,
        y: j * 16,
        vx: (Math.random() - 0.5) * 0.5,
        vy: (Math.random() - 0.5) * 0.5,
        pressure: 1.0
      });
    }
  }
}

// Burgers ë°©ì •ì‹ ì ìš©
function applyBurgersEquation(drug) {
  const viscosity = parseFloat(document.getElementById('viscosity').value);
  const dt = 0.1;
  
  fluidField.forEach((cell, idx) => {
    // âˆ‚u/âˆ‚t + uâˆ‚u/âˆ‚x = Î½âˆ‚Â²u/âˆ‚xÂ²
    const advection = cell.vx * cell.vx * 0.1;
    const diffusion = viscosity * (Math.random() - 0.5);
    
    cell.vx += (-advection + diffusion) * dt * drug.effectStrength;
    cell.vy += (-advection + diffusion) * dt * drug.effectStrength;
    
    const speed = Math.sqrt(cell.vx * cell.vx + cell.vy * cell.vy);
    if (speed > 2) {
      cell.vx = (cell.vx / speed) * 2;
      cell.vy = (cell.vy / speed) * 2;
    }
  });
}

// ì „ì êµ¬ë¦„ ìƒì„±
function createElectronCloud(region, count) {
  const newElectrons = [];
  const diffusion = parseFloat(document.getElementById('diffusion').value);
  
  for (let i = 0; i < count; i++) {
    const r = diffusion * Math.sqrt(-2 * Math.log(Math.random()));
    const theta = 2 * Math.PI * Math.random();
    
    newElectrons.push({
      x: region.x + r * Math.cos(theta),
      y: region.y + r * Math.sin(theta),
      vx: (Math.random() - 0.5) * 0.5,
      vy: (Math.random() - 0.5) * 0.5,
      energy: Math.random() * 2,
      phase: Math.random() * Math.PI * 2
    });
  }
  return newElectrons;
}

function quantumTunneling(electron) {
  const tunnelingProb = parseFloat(document.getElementById('tunneling').value); // ê¸°ì¡´ ID ì‚¬ìš©
  
  if (Math.random() < tunnelingProb) {
    const tunnelingDistance = 50 + Math.random() * 100;
    const angle = Math.random() * Math.PI * 2;
    electron.x += tunnelingDistance * Math.cos(angle);
    electron.y += tunnelingDistance * Math.sin(angle);
    return true;
  }
  return false;
}

function calculateAcidBase() {
  const pH = parseFloat(document.getElementById('pH').value);
  const drug = drugData[currentDrug];
  const effectivePH = pH + drug.pH_shift;
  const pKa = 7.4;
  const ratio = Math.pow(10, effectivePH - pKa);
  
  return {
    pH: effectivePH,
    acidicForm: 1 / (1 + ratio),
    basicForm: ratio / (1 + ratio),
    bufferCapacity: 2.303 * ratio / Math.pow(1 + ratio, 2)
  };
}

// ì…ì ìƒì„± (ìˆ˜ìš©ì²´ ê°ë„ ë°˜ì˜)
function createParticles(activeRegions, drug) {
  particles = [];
  const receptors = getReceptorSettings();
  
  // ìˆ˜ìš©ì²´ ê°ë„ê°€ ë†’ì„ìˆ˜ë¡ ì…ìê°€ ë” ë§ì´/ê°•í•˜ê²Œ ë³´ì„
  // í‰ê·  ê°ë„ ê³„ì‚°
  const avgSensitivity = (receptors.dopamine + receptors.serotonin + receptors.gaba + receptors.glutamate) / 4;
  
  const particleCount = Math.floor(drug.effectStrength * 60 * avgSensitivity);
  
  activeRegions.forEach(regionKey => {
    const region = brainRegions[regionKey];
    if (!region) return;
    
    const count = Math.floor(particleCount / activeRegions.length);
    for (let i = 0; i < count; i++) {
      const type = ['dopamine', 'serotonin', 'gaba', 'glutamate'][Math.floor(Math.random() * 4)];
      let speedMod = 1.0;
      
      // ìˆ˜ìš©ì²´ íƒ€ì…ë³„ ì†ë„/ìˆ˜ëª… ë³´ì •
      if (type === 'dopamine') speedMod = receptors.dopamine;
      if (type === 'serotonin') speedMod = receptors.serotonin;
      if (type === 'gaba') speedMod = receptors.gaba;
      if (type === 'glutamate') speedMod = receptors.glutamate;

      particles.push({
        x: region.x + (Math.random() - 0.5) * region.size,
        y: region.y + (Math.random() - 0.5) * region.size,
        vx: (Math.random() - 0.5) * 3 * speedMod,
        vy: (Math.random() - 0.5) * 3 * speedMod,
        life: 1.0 * speedMod, // ê°ë„ê°€ ë†’ìœ¼ë©´ ìˆ˜ëª…ë„ ê¸¸ê²Œ(ê²°í•© ì˜¤ë˜í•¨)
        type: type,
        sensitivity: speedMod
      });
    }
  });
}

// ë‡Œ ì™¸ê³½ì„ 
function drawBrainOutline() {
  ctx.strokeStyle = '#333';
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.ellipse(500, 350, 250, 280, 0, 0, Math.PI * 2);
  ctx.moveTo(350, 600);
  ctx.quadraticCurveTo(450, 650, 550, 600);
  ctx.moveTo(580, 550);
  ctx.lineTo(600, 650);
  ctx.stroke();
  
  ctx.strokeStyle = '#222';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(500, 100);
  ctx.lineTo(500, 550);
  ctx.stroke();
}

// ë Œë”ë§
function render() {
  if (isPaused) return;
  
  ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  drawBrainOutline();
  
  const drug = drugData[currentDrug];
  const activeRegions = drug.activeRegions || [];
  const inactiveRegions = drug.inactiveRegions || [];
  const helixDensity = parseFloat(document.getElementById('helixDensity').value);
  const receptors = getReceptorSettings();

  time += 0.1;
  
  // Burgers Equation
  applyBurgersEquation(drug);
  
  // ìœ ì²´ í•„ë“œ
  ctx.globalAlpha = 0.1;
  fluidField.forEach(cell => {
    const speed = Math.sqrt(cell.vx * cell.vx + cell.vy * cell.vy);
    ctx.strokeStyle = `rgba(79, 195, 247, ${speed * 0.5})`;
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(cell.x, cell.y);
    ctx.lineTo(cell.x + cell.vx * 10, cell.y + cell.vy * 10);
    ctx.stroke();
  });
  ctx.globalAlpha = 1;
  
  // ì‹œëƒ…ìŠ¤ ì—°ê²° (ìˆ˜ìš©ì²´ ê°ë„ì— ë”°ë¼ ë°ê¸° ì¡°ì ˆ)
  activeRegions.forEach(key1 => {
    const region1 = brainRegions[key1];
    if (!region1) return;
    
    activeRegions.forEach(key2 => {
      if (key1 >= key2) return;
      const region2 = brainRegions[key2];
      if (!region2 || Math.random() > helixDensity) return;
      
      const avgSens = (receptors.dopamine + receptors.glutamate) / 2; // ëŒ€ëµì  í™œì„±ë„
      const alpha = 0.1 * avgSens;

      const gradient = ctx.createLinearGradient(region1.x, region1.y, region2.x, region2.y);
      gradient.addColorStop(0, `rgba(79, 195, 247, ${alpha + 0.3})`);
      gradient.addColorStop(1, `rgba(79, 195, 247, ${alpha})`);
      
      ctx.strokeStyle = gradient;
      ctx.lineWidth = (1 + drug.effectStrength * 2) * avgSens;
      ctx.beginPath();
      ctx.moveTo(region1.x, region1.y);
      ctx.lineTo(region2.x, region2.y);
      ctx.stroke();
    });
  });
  
  // ì „ì êµ¬ë¦„
  electrons.forEach((e, idx) => {
    e.x += e.vx;
    e.y += e.vy;
    e.phase += 0.1;
    
    if (quantumTunneling(e)) {
      e.energy += 0.5;
    }
    
    const psi = Math.sin(e.phase) * Math.exp(-e.energy * 0.1);
    const probability = psi * psi;
    
    ctx.fillStyle = `rgba(0, 255, 0, ${probability * 0.6})`;
    ctx.beginPath();
    ctx.arc(e.x, e.y, 2, 0, Math.PI * 2);
    ctx.fill();
    
    if (e.x < 0 || e.x > canvas.width || e.y < 0 || e.y > canvas.height) {
      electrons.splice(idx, 1);
    }
  });
  
  // ì‹ ê²½ì „ë‹¬ë¬¼ì§ˆ ì…ì
  particles.forEach((p, idx) => {
    p.x += p.vx;
    p.y += p.vy;
    p.life -= 0.008; // ê¸°ë³¸ ê°ì†Œ
    
    if (p.life <= 0) {
      particles.splice(idx, 1);
      return;
    }
    
    const colors = {
      dopamine: [255, 170, 0],
      serotonin: [255, 100, 255],
      gaba: [100, 100, 255],
      glutamate: [255, 255, 100]
    };
    const c = colors[p.type] || [255, 170, 0];
    
    // ìˆ˜ìš©ì²´ ê°ë„(p.sensitivity)ê°€ ë‚®ìœ¼ë©´ ì…ìê°€ íë¦¿í•¨
    ctx.fillStyle = `rgba(${c[0]}, ${c[1]}, ${c[2]}, ${p.life * 0.8 * p.sensitivity})`;
    ctx.beginPath();
    ctx.arc(p.x, p.y, 2.5 * p.sensitivity, 0, Math.PI * 2);
    ctx.fill();
  });
  
  // ë‡Œ ì˜ì—­
  Object.entries(brainRegions).forEach(([key, region]) => {
    const isActive = activeRegions.includes(key);
    const isInactive = inactiveRegions && inactiveRegions.includes(key);
    
    if (isActive && Math.random() < helixDensity) {
      const helix = generateDNAHelix(region.dna, region.x, region.y, 8);
      helix.forEach(strand => {
        ctx.strokeStyle = '#444';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(strand.x1, strand.y1);
        ctx.lineTo(strand.x2, strand.y2);
        ctx.stroke();
        ctx.fillStyle = strand.color1;
        ctx.beginPath();
        ctx.arc(strand.x1, strand.y1, 2, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = strand.color2;
        ctx.beginPath();
        ctx.arc(strand.x2, strand.y2, 2, 0, Math.PI * 2);
        ctx.fill();
      });
    }
    
    if (isActive) {
      const glowSize = region.size + 12 + Math.sin(time * 0.5) * 6;
      const gradient = ctx.createRadialGradient(region.x, region.y, region.size / 2, region.x, region.y, glowSize);
      gradient.addColorStop(0, 'rgba(255, 68, 68, 0.5)');
      gradient.addColorStop(1, 'rgba(255, 68, 68, 0)');
      ctx.fillStyle = gradient;
      ctx.beginPath();
      ctx.arc(region.x, region.y, glowSize, 0, Math.PI * 2);
      ctx.fill();
    }
    
    if (isActive) {
      ctx.fillStyle = '#ff4444';
      ctx.strokeStyle = '#ff6666';
    } else if (isInactive) {
      ctx.fillStyle = '#1a1a1a';
      ctx.strokeStyle = '#333';
    } else {
      ctx.fillStyle = '#444';
      ctx.strokeStyle = '#666';
    }
    
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(region.x, region.y, region.size / 2, 0, Math.PI * 2);
    ctx.fill();
    ctx.stroke();
    
    ctx.fillStyle = isActive ? '#fff' : '#888';
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(region.name, region.x, region.y + region.size / 2 + 14);
  });
  
  ctx.fillStyle = '#4fc3f7';
  ctx.font = 'bold 14px sans-serif';
  ctx.textAlign = 'left';
  ctx.fillText(`${drug.name} | ì‹œê°„: ${time.toFixed(1)}ì´ˆ`, 20, 25);
  
  // ì…ì ìƒì„± ì¡°ê±´ì— ìˆ˜ìš©ì²´ ê°ë„ ë°˜ì˜
  const avgSens = (receptors.dopamine + receptors.serotonin + receptors.gaba + receptors.glutamate) / 4;
  if (particles.length < (80 * avgSens) && activeRegions.length > 0 && Math.random() < 0.3) {
    createParticles(activeRegions, drug);
  }
  
  if (electrons.length < 150 && activeRegions.length > 0 && Math.random() < 0.2) {
    activeRegions.forEach(key => {
      const region = brainRegions[key];
      if (region) {
        electrons.push(...createElectronCloud(region, 3));
      }
    });
  }
  
  animationFrame = requestAnimationFrame(render);
}

// ì •ë³´ íŒ¨ë„ ì—…ë°ì´íŠ¸
function updateInfoPanel() {
  const drug = drugData[currentDrug];
  const acidBase = calculateAcidBase();
  const diffusion = parseFloat(document.getElementById('diffusion').value);
  const viscosity = parseFloat(document.getElementById('viscosity').value);
  const tunneling = parseFloat(document.getElementById('tunneling').value);
  const receptors = getReceptorSettings();
  
  let html = `
    <div class="info-section">
      <div class="info-title">ğŸ’Š ${drug.name}</div>
      íš¨ê³¼ ê°•ë„: <span class="value-display">${(drug.effectStrength * 100).toFixed(0)}%</span><br>
      í™œì„± ì˜ì—­: <span class="value-display">${(drug.activeRegions || []).length}ê°œ</span>
    </div>

    <div class="info-section">
      <div class="info-title">ğŸ”Œ ìˆ˜ìš©ì²´ ê²°í•© ìƒíƒœ (Receptor Binding)</div>
      ì„¤ì •ëœ ë¯¼ê°ë„(Affinity)ì— ë”°ë¥¸ ì˜ˆìƒ ë°˜ì‘:<br>
      <ul>
        <li>D2 (ë„íŒŒë¯¼): <span class="value-display">${receptors.dopamine.toFixed(1)}x</span> ${receptors.dopamine < 1 ? '(ë‚´ì„±)' : receptors.dopamine > 1 ? '(ê³¼ë¯¼)' : '(ì •ìƒ)'}</li>
        <li>5-HT (ì„¸ë¡œí† ë‹Œ): <span class="value-display">${receptors.serotonin.toFixed(1)}x</span></li>
        <li>GABA-A: <span class="value-display">${receptors.gaba.toFixed(1)}x</span></li>
        <li>NMDA: <span class="value-display">${receptors.glutamate.toFixed(1)}x</span></li>
      </ul>
      <div class="equation">
        Total Effect = ë†ë„[C] Ã— ì¹œí™”ë ¥[Kd]â»Â¹<br>
        í˜„ì¬ ë³´ì • ê³„ìˆ˜: ${((receptors.dopamine + receptors.serotonin + receptors.gaba + receptors.glutamate)/4).toFixed(2)}
      </div>
    </div>
    
    <div class="info-section">
      <div class="info-title">ğŸ§¬ ì‹ ê²½ì „ë‹¬ë¬¼ì§ˆ ë†ë„ (ë³´ì •ë¨)</div>
      <strong>ë„íŒŒë¯¼ (Dopamine)</strong>
      <div class="neurotransmitter-bar">
        <div class="nt-fill" style="width:${drug.dopamine * 100 * receptors.dopamine}%; max-width:100%; background:linear-gradient(90deg, #ff4444, #ff8888);"></div>
      </div>
      
      <strong>ì„¸ë¡œí† ë‹Œ (Serotonin)</strong>
      <div class="neurotransmitter-bar">
        <div class="nt-fill" style="width:${drug.serotonin * 100 * receptors.serotonin}%; max-width:100%; background:linear-gradient(90deg, #ff44ff, #ff88ff);"></div>
      </div>
      
      <strong>GABA</strong>
      <div class="neurotransmitter-bar">
        <div class="nt-fill" style="width:${drug.gaba * 100 * receptors.gaba}%; max-width:100%; background:linear-gradient(90deg, #4444ff, #8888ff);"></div>
      </div>
      
      <strong>ê¸€ë£¨íƒ€ë©”ì´íŠ¸ (Glutamate)</strong>
      <div class="neurotransmitter-bar">
        <div class="nt-fill" style="width:${drug.glutamate * 100 * receptors.glutamate}%; max-width:100%; background:linear-gradient(90deg, #ffff44, #ffff88);"></div>
      </div>
    </div>

    <div class="info-section">
      <div class="info-title">ğŸŒŠ Navier-Stokes 2D ë°©ì •ì‹</div>
      ìœ ì²´ì—­í•™ì  ì‹ ê²½ì „ë‹¬ë¬¼ì§ˆ íë¦„<br>
      <div class="equation">
        âˆ‚u/âˆ‚t + (uÂ·âˆ‡)u = -âˆ‡p/Ï + Î½âˆ‡Â²u<br>
        ì ì„±ê³„ìˆ˜ Î½ = <span class="value-display">${viscosity}</span>
      </div>
    </div>
    
    <div class="info-section">
      <div class="info-title">âš¡ ì „ì ë¶„í¬ (ì–‘ìì—­í•™)</div>
      í™•ì‚°ê³„ìˆ˜ D = <span class="value-display">${diffusion}</span><br>
      <div class="equation">
        Ï(r) = |Ïˆ|Â² = exp(-rÂ²/2ÏƒÂ²)<br>
        Ïƒ = âˆš(2Dt) (Gaussian ë¶„í¬)
      </div>
    </div>
    
    <div class="info-section">
      <div class="info-title">ğŸ¯ ì–‘ì í„°ë„ë§</div>
      í„°ë„ë§ í™•ë¥ : <span class="value-display">${(tunneling * 100).toFixed(1)}%</span><br>
      <div class="equation">
        T â‰ˆ exp(-2Îºd)<br>
        Îº = âˆš(2m(V-E)/â„Â²)
      </div>
    </div>
    
    <div class="info-section">
      <div class="info-title">ğŸ§ª ì‚°-ì—¼ê¸° í‰í˜•</div>
      <div class="equation">
        pH = pKa + log([Aâ»]/[HA])<br>
        í˜„ì¬ pH = <span class="value-display">${acidBase.pH.toFixed(2)}</span>
      </div>
    </div>
  `;
  
  document.getElementById('rightPanel').innerHTML = html;
}

// ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
document.getElementById('applyBtn').onclick = () => {
  currentDrug = document.getElementById('drugSelect').value;
  time = 0;
  particles = [];
  electrons = [];
  initFluidField();
  
  const drug = drugData[currentDrug];
  createParticles(drug.activeRegions || [], drug);
  
  (drug.activeRegions || []).forEach(key => {
    const region = brainRegions[key];
    if (region) {
      electrons.push(...createElectronCloud(region, 10));
    }
  });
  
  updateInfoPanel();
  isPaused = false;
  
  if (animationFrame) cancelAnimationFrame(animationFrame);
  render();
};

document.getElementById('pauseBtn').onclick = () => {
  isPaused = !isPaused;
  document.getElementById('pauseBtn').textContent = isPaused ? 'â–¶ï¸ ì¬ìƒ' : 'â¸ï¸ ì¼ì‹œì •ì§€';
  if (!isPaused) render();
};

document.getElementById('resetBtn').onclick = () => {
  document.getElementById('drugSelect').value = 'none';
  document.getElementById('dosage').value = '100';
  document.getElementById('timeElapsed').value = '30';
  
  // ìˆ˜ìš©ì²´ ì´ˆê¸°í™”
  document.getElementById('rec_dopamine').value = '1.0';
  document.getElementById('rec_serotonin').value = '1.0';
  document.getElementById('rec_gaba').value = '1.0';
  document.getElementById('rec_glutamate').value = '1.0';
  document.getElementById('val_d2').innerText = '1.0';
  document.getElementById('val_5ht').innerText = '1.0';
  document.getElementById('val_gaba').innerText = '1.0';
  document.getElementById('val_nmda').innerText = '1.0';

  document.getElementById('helixDensity').value = '0.7';
  document.getElementById('viscosity').value = '0.05';
  document.getElementById('diffusion').value = '1.5';
  document.getElementById('tunneling').value = '0.08';
  document.getElementById('pH').value = '7.4';
  currentDrug = 'none';
  time = 0;
  particles = [];
  electrons = [];
  initFluidField();
  updateInfoPanel();
  isPaused = false;
  
  if (animationFrame) cancelAnimationFrame(animationFrame);
  render();
};

document.getElementById('saveBtn').onclick = () => {
  const link = document.createElement('a');
  link.download = `brain_simulation_${currentDrug}_${Date.now()}.png`;
  link.href = canvas.toDataURL();
  link.click();
};

// ìˆ˜ìš©ì²´ ìŠ¬ë¼ì´ë” ë³€ê²½ ì‹œ íŒ¨ë„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
['rec_dopamine', 'rec_serotonin', 'rec_gaba', 'rec_glutamate'].forEach(id => {
  document.getElementById(id).addEventListener('input', updateInfoPanel);
});

// ì´ˆê¸°í™”
initFluidField();
updateInfoPanel();
render();
</script>
</body>
</html>